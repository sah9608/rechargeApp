<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.recharge.user.dao.UserDAO">

    <!-- íšŒì›ê°€ìž… -->
    <insert id="insertUser" parameterType="com.recharge.user.vo.UserVO">
        INSERT INTO TB_USER (
        USER_ID, USER_PWD, USER_EMAIL,
        USER_NAME, USER_NICKNAME, USER_BIRTH,
        USER_GENDER, USER_PHONE, USER_CARMODEL,
        USER_ROLE, DEVICE_OS, DEVICE_VERSION,
        FCM_TOKEN, CREATE_DATE, CREATE_ID,
        UPDATED_DATE, UPDATED_ID
        ) VALUES (
        #{userId},
        #{userPwd},
        #{userEmail},
        #{userName},
        #{userNickname},
        #{userBirth},
        #{userGender},
        #{userPhone},
        #{userCarModel},
        #{userRole},
        #{deviceOs, jdbcType=VARCHAR},
        #{deviceVersion, jdbcType=VARCHAR},
        #{fcmToken, jdbcType=VARCHAR},
        SYSDATE,
        #{createId, jdbcType=VARCHAR},
        SYSDATE,
        #{updatedId, jdbcType=VARCHAR}
        )
    </insert>

    <!-- ì•„ì´ë”” ì¤‘ë³µ ì²´í¬ -->
    <select id="checkUserId" resultType="int">
        SELECT COUNT(*)
        FROM TB_USER
        WHERE USER_ID = #{userId,jdbcType=VARCHAR}
    </select>

    <!-- ë‹‰ë„¤ìž„ ì¤‘ë³µ ì²´í¬ -->
    <select id="checkUserNickName" resultType="int">
        SELECT COUNT(*)
        FROM TB_USER
        WHERE USER_NICKNAME = #{userNickname,jdbcType=VARCHAR}
    </select>

    <!-- ë¡œê·¸ì¸ -->
    <select id="getUserById" parameterType="string" resultType="com.recharge.user.vo.UserVO">
        SELECT
        USER_ID, USER_PWD, USER_EMAIL,
        USER_NAME, USER_NICKNAME, USER_BIRTH,
        USER_GENDER, USER_PHONE, USER_CARMODEL,
        USER_ROLE, DEVICE_OS, DEVICE_VERSION,
        FCM_TOKEN, CREATE_DATE, CREATE_ID,
        UPDATED_DATE, UPDATED_ID
        FROM TB_USER
        WHERE USER_ID = #{userId}
    </select>

    <!-- ë””ë°”ì´ìŠ¤ ì •ë³´ -->
    <update id="updateDeviceInfo" parameterType="com.recharge.user.vo.UserVO">
        UPDATE TB_USER
        SET
        DEVICE_OS = #{deviceOs, jdbcType=VARCHAR},
        DEVICE_VERSION = #{deviceVersion, jdbcType=VARCHAR},
        FCM_TOKEN = #{fcmToken, jdbcType=VARCHAR},
        UPDATED_DATE = SYSDATE,
        UPDATED_ID = #{updatedId, jdbcType=VARCHAR}
        WHERE USER_ID = #{userId}
    </update>

    <!--ì•„ì´ë”” ì°¾ê¸° -->
    <select id="findUserId" parameterType="com.recharge.user.vo.UserVO" resultType="String">
        SELECT USER_ID
        FROM TB_USER
        WHERE USER_NAME = #{userName}
        AND USER_EMAIL= #{userEmail}
    </select>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° : ìœ ì € í™•ì¸ -->
    <select id="findUserForPasswordReset" parameterType="com.recharge.user.vo.UserVO" resultType="com.recharge.user.vo.UserVO">
        SELECT
        USER_ID, USER_EMAIL, USER_NAME,
        RESET_TOKEN, TOKEN_EXPIRE
        FROM TB_USER
        WHERE USER_ID = #{userId}
        AND USER_NAME = #{userName}
        AND USER_EMAIL = #{userEmail}
    </select>


    <!-- ë¹„ë°€ë²ˆí˜¸ ìž¬ì„¤ì • í† í° ì €ìž¥ -->
    <update id="updateResetToken" parameterType="com.recharge.user.vo.UserVO">
        UPDATE TB_USER
        SET RESET_TOKEN = #{resetToken},
        TOKEN_EXPIRE = #{tokenExpire},
        UPDATED_DATE = SYSDATE,
        UPDATED_ID = #{userId}
        WHERE USER_ID = #{userId}
        AND USER_EMAIL = #{userEmail}
    </update>


    <!-- í† í°ìœ¼ë¡œ ì‚¬ìš©ìž ì¡°íšŒ (ìœ íš¨ì„± ê²€ì‚¬ í¬í•¨) -->
    <select id="getUserByResetToken" parameterType="string" resultType="com.recharge.user.vo.UserVO">
        SELECT USER_ID, USER_EMAIL,
        RESET_TOKEN, TOKEN_EXPIRE
        FROM TB_USER
        WHERE RESET_TOKEN = #{resetToken}
        AND TOKEN_EXPIRE > SYSDATE    <!-- ðŸ”¥ ìœ íš¨ê¸°ê°„ ê²€ì¦ -->
    </select>


    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (í† í° ì‚¬ìš© í›„ ì‚­ì œ) -->
    <update id="updateUserPassword" parameterType="com.recharge.user.vo.UserVO">
        UPDATE TB_USER
        SET USER_PWD = #{userPwd},
        RESET_TOKEN = NULL,
        TOKEN_EXPIRE = NULL,
        UPDATED_DATE = SYSDATE,
        UPDATED_ID = #{userId}
        WHERE USER_ID = #{userId}
    </update>

    <!-- ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬ -->
    <select id="checkUserEmail" resultType="int">
        SELECT COUNT(*)
        FROM TB_USER
        WHERE USER_EMAIL = #{userEmail,jdbcType=VARCHAR}
    </select>

    <update id="updateEmailAuthCode" parameterType="com.recharge.user.vo.UserVO">
        MERGE INTO TB_USER u
        USING (SELECT #{userEmail} AS USER_EMAIL FROM dual) d
        ON (u.USER_EMAIL = d.USER_EMAIL)
        WHEN MATCHED THEN UPDATE SET
        EMAIL_AUTH_CODE = #{emailAuthCode},
        EMAIL_AUTH_EXPIRE = #{emailAuthExpire},
        UPDATED_DATE = SYSDATE,
        UPDATED_ID = #{userEmail}
        WHEN NOT MATCHED THEN
        INSERT (
        USER_EMAIL,
        USER_PWD,
        USER_NAME,
        USER_NICKNAME,
        USER_BIRTH,
        USER_ROLE,
        EMAIL_AUTH_CODE,
        EMAIL_AUTH_EXPIRE,
        CREATE_DATE,
        CREATE_ID
        )
        VALUES (
        #{userEmail},
        'TEMP',
        'TEMP',
        'TEMP',
        '19900101',
        'TEMP',
        #{emailAuthCode},
        #{emailAuthExpire},
        SYSDATE,
        #{userEmail}
        )
    </update>




    <!-- ì¸ì¦ ì½”ë“œ í™•ì¸ -->
    <select id="getUserByEmailAuthCode" parameterType="com.recharge.user.vo.UserVO"
            resultType="com.recharge.user.vo.UserVO">
        SELECT USER_ID, USER_EMAIL, EMAIL_VERIFIED
        FROM TB_USER
        WHERE EMAIL_AUTH_CODE = #{emailAuthCode}
        AND USER_EMAIL = #{userEmail}
        AND EMAIL_AUTH_EXPIRE > SYSDATE
    </select>

    <!-- ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ -->
    <update id="verifyUserEmail" parameterType="com.recharge.user.vo.UserVO">
        UPDATE TB_USER
        SET EMAIL_VERIFIED = 'Y',
        EMAIL_AUTH_CODE = NULL,
        EMAIL_AUTH_EXPIRE = NULL,
        UPDATED_DATE = SYSDATE,
        UPDATED_ID = #{userEmail}
        WHERE USER_EMAIL = #{userEmail}
    </update>

    <!-- ì´ë©”ì¼ ì¸ì¦ í›„ ìµœì¢… ìœ ì € ì •ë³´ ì—…ë°ì´íŠ¸ -->
    <update id="updateUserAfterEmailVerified" parameterType="com.recharge.user.vo.UserVO">
        UPDATE TB_USER
        SET USER_ID = #{userId},
        USER_PWD = #{userPwd},
        USER_NAME = #{userName},
        USER_NICKNAME = #{userNickname},
        USER_BIRTH = #{userBirth},
        USER_GENDER = #{userGender},
        USER_PHONE = #{userPhone},
        USER_CARMODEL = #{userCarModel},
        USER_ROLE = 'USER',
        UPDATED_DATE = SYSDATE,
        UPDATED_ID = #{updatedId}
        WHERE USER_EMAIL = #{userEmail}
        AND EMAIL_VERIFIED = 'Y'
    </update>

    <update id="updateUserInfo" parameterType="com.recharge.user.vo.UserVO">
        UPDATE TB_USER
        SET
            UPDATED_DATE = SYSDATE,
            UPDATED_ID = #{userId}
            <if test="userName != null">, USER_NAME = #{userName}</if>
            <if test="userNickname != null">, USER_NICKNAME = #{userNickname} </if>
            <if test="userPhone != null"> USER_PHONE = #{userPhone} </if>
            <if test="userCarModel != null"> USER_CARMODEL = #{userCarModel} </if>
        WHERE USER_ID = #{userId}
    </update>
    <update id="updateProfileUserPassword" parameterType="com.recharge.user.vo.UserVO">
        UPDATE TB_USER
        SET USER_PWD = #{userPwd, jdbcType=VARCHAR},
        UPDATED_DATE = SYSDATE,
        UPDATED_ID = #{updatedId, jdbcType=VARCHAR}
        WHERE USER_ID = #{userId, jdbcType=VARCHAR}
    </update>
</mapper>
