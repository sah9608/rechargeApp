<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.recharge.movie.dao.MovieDAO">
    <resultMap id="MovieMap" type="MovieVO">
        <id     column="MOVIE_ID"        property="movieId"/>
        <result column="COMMON_CATEGORY_ID"  property="commonCategoryId"/>
        <result column="MOVIE_POSTER"        property="moviePoster"/>
        <result column="MOVIE_TITLE"         property="movieTitle"/>
        <result column="MOVIE_SCORE"         property="movieScore"/>
        <result column="MOVIE_COMMENT"       property="movieComment"/>
        <result column="GENRE_NAME"          property="genreName"/>
        <result column="GENRE_CODE"          property="genreCode"/>
        <result column="MOVIE_DIRECTOR"      property="movieDirector"/>
        <result column="MOVIE_ACTOR"         property="movieActor"/>
        <result column="RELEASE_DATE_STR"    property="movieDate"/>
        <result column="MOVIE_TRAILER"       property="movieTrailer"/>
        <result column="CREATE_DATE"         property="createDate"/>
        <result column="CREATE_ID"           property="createId"/>
        <result column="UPDATED_DATE"        property="updatedDate"/>
        <result column="UPDATED_ID"          property="updatedId"/>
        <result column="MOVIE_FLAG"          property="movieFlag"/>
    </resultMap>

    <sql id="BaseSelect">
        SELECT
        M.MOVIE_ID,
        M.COMMON_CATEGORY_ID,
        M.MOVIE_POSTER,
        M.MOVIE_TITLE,
        M.MOVIE_SCORE,
        M.MOVIE_COMMENT,
        M.MOVIE_DIRECTOR,
        M.MOVIE_ACTOR,
        TO_CHAR(M.MOVIE_DATE, 'YYYY-MM-DD') AS RELEASE_DATE_STR,
        M.MOVIE_TRAILER,
        M.CREATE_DATE,
        M.CREATE_ID,
        M.UPDATED_DATE,
        M.UPDATED_ID,
        M.MOVIE_FLAG,
        C.COMMON_CATEGORY_NAME AS GENRE_NAME,
        C.COMMON_CATEGORY_CODE AS GENRE_CODE
        FROM TB_MOVIE M
        LEFT JOIN TB_COMMON_CATEGORY C
        ON M.COMMON_CATEGORY_ID = C.COMMON_CATEGORY_ID
    </sql>

    <!--    인기영화 기존 데이터 삭제하기 -->
    <delete id="deletePopularMovies">
        DELETE FROM TB_MOVIE WHERE MOVIE_FLAG = 'POPULAR'
    </delete>

    <!--   인기영화 신규  저장 -->
    <insert id="insertPopularMovie">
        INSERT INTO TB_MOVIE (
        MOVIE_ID,
        COMMON_CATEGORY_ID,
        MOVIE_POSTER,
        MOVIE_TITLE,
        MOVIE_SCORE,
        MOVIE_COMMENT,
        MOVIE_DIRECTOR,
        MOVIE_ACTOR,
        MOVIE_DATE,
        MOVIE_TRAILER,
        CREATE_DATE,
        CREATE_ID,
        UPDATED_DATE,
        UPDATED_ID,
        MOVIE_FLAG
        ) VALUES (
        #{movieId},
        #{commonCategoryId, jdbcType=VARCHAR},
        #{moviePoster, jdbcType=VARCHAR},
        #{movieTitle, jdbcType=VARCHAR},
        #{movieScore, jdbcType=VARCHAR},
        #{movieComment, jdbcType=VARCHAR},
        #{movieDirector, jdbcType=VARCHAR},
        #{movieActor, jdbcType=VARCHAR},
        #{movieDate, jdbcType=VARCHAR},
        #{movieTrailer, jdbcType=VARCHAR},
        SYSDATE,
        'SYSTEM',
        SYSDATE,
        'SYSTEM',
        'POPULAR'
        )
    </insert>

<!--    인기 영화 조회 -->
    <select id="selectWeeklyPopularMovies" resultMap="MovieMap">
        <include refid="BaseSelect"/>
        WHERE M.MOVIE_FLAG = 'POPULAR'
        ORDER BY M.MOVIE_DATE DESC, M.MOVIE_ID DESC
    </select>

<!-- 영화 상세 조회 페이지-->
    <select id="selectMovieById" parameterType="long" resultMap="MovieMap">
        <include refid="BaseSelect"/>
        WHERE M.MOVIE_ID = #{movieId}
    </select>

<!--    인기 영화 업데이트 날짜 조회-->
    <select id="getLatestPopularCreateDate" resultType="string">
        SELECT TO_CHAR(MAX(CREATE_DATE), 'YYYY-MM-DD')
        FROM TB_MOVIE
        WHERE MOVIE_FLAG = 'POPULAR'
    </select>
<!--장르 common category 테이블 매핑-->
    <select id="findCategoryId" resultType="string">
        SELECT COMMON_CATEGORY_ID
        FROM TB_COMMON_CATEGORY
        WHERE COMMON_CATEGORY_SYSTEM = #{system}
        AND COMMON_CATEGORY_CODE = #{code}
    </select>
<!--영화 중복 방지-->
    <select id="existsByMovieId" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM TB_MOVIE
        WHERE MOVIE_ID = #{movieId}
    </select>
<!--비슷한 영화 저장-->
    <insert id="insertSimilarMovie">
        INSERT INTO TB_MOVIE (
        MOVIE_ID,
        COMMON_CATEGORY_ID,
        MOVIE_POSTER,
        MOVIE_TITLE,
        MOVIE_SCORE,
        MOVIE_COMMENT,
        MOVIE_DIRECTOR,
        MOVIE_ACTOR,
        MOVIE_DATE,
        MOVIE_TRAILER,
        CREATE_DATE,
        CREATE_ID,
        UPDATED_DATE,
        UPDATED_ID,
        MOVIE_FLAG
        ) VALUES (
        #{movieId},
        #{commonCategoryId, jdbcType=VARCHAR},
        #{moviePoster, jdbcType=VARCHAR},
        #{movieTitle, jdbcType=VARCHAR},
        #{movieScore, jdbcType=VARCHAR},
        #{movieComment, jdbcType=VARCHAR},
        #{movieDirector, jdbcType=VARCHAR},
        #{movieActor, jdbcType=VARCHAR},
        #{movieDate, jdbcType=VARCHAR},
        #{movieTrailer, jdbcType=VARCHAR},
        SYSDATE,
        'SYSTEM',
        SYSDATE,
        'SYSTEM',
        'SIMILAR'
        )
    </insert>

    <select id="findRandomMovies" resultMap="MovieMap">
        <include refid="BaseSelect"/>
        ORDER BY DBMS_RANDOM.VALUE
    </select>


</mapper>
